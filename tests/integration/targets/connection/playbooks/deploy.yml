---
- hosts: all
  gather_facts: false

  tasks:
    - include_vars: aws_resources.yml
      when: '"aws" in group_names'

    - include_vars: k8s_resources.yml
      when: '"k8s" in group_names'

    - name: 'Ensure that we have virtualenv available to us'
      pip:
        name: virtualenv

    - block:
        - name: 'Create temporary directory for pip environment'
          tempfile:
            state: directory
            suffix: .test
          register: result

        - set_fact:
            pip_directory: "{{ result.path }}"

        - name: Install required package into virtualenv
          pip:
            name: "{{ required_libs }}" 
            virtualenv: "{{ pip_directory }}/virtualenv"
            virtualenv_command: "{{ ansible_python_interpreter }} -m virtualenv"

        - name: Deploy resources
          cloud.pravic.resources:
            state: "{{ state | default('present') }}"
          vars:
            ansible_python_interpreter: "{{ pip_directory }}/virtualenv/bin/python"

      always:
        - name: Delete temporary directory
          file:
            state: absent
            path: '{{ pip_directory }}'
          ignore_errors: true
          when: pip_directory is defined
